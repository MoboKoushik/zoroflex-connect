<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zorrofin Connect - Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      /* ========================================
       CSS Variables - Modern Desktop Color Palette
       ======================================== */
      :root {
        --primary: #0078d4;
        --primary-dark: #106ebe;
        --primary-light: #deecf9;
        --success: #107c10;
        --success-light: #dff6dd;
        --danger: #d13438;
        --danger-light: #fde7e9;
        --warning: #ffaa44;
        --warning-light: #fff4e5;
        --bg-main: #fafafa;
        --bg-sidebar: #ffffff;
        --bg-hover: #f3f3f3;
        --bg-card: #ffffff;
        --border-color: #e1e1e1;
        --text-primary: #323130;
        --text-secondary: #605e5c;
        --border-radius: 8px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --status-success-bg: #dff6dd;
        --status-success-border: #107c10;
        --status-warning-bg: #fff4e5;
        --status-warning-border: #ffaa44;
        --status-danger-bg: #fde7e9;
        --status-danger-border: #d13438;
        --btn-logout-hover: #fef6f6;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Dark Mode Variables */
      [data-theme="dark"] {
        --bg-main: #1e1e1e;
        --bg-sidebar: #252526;
        --bg-hover: #2d2d30;
        --bg-card: #2d2d30;
        --border-color: #3e3e42;
        --text-primary: #cccccc;
        --text-secondary: #858585;
        --status-success-bg: #1e4620;
        --status-success-border: #107c10;
        --status-warning-bg: #4a3a1f;
        --status-warning-border: #ffaa44;
        --status-danger-bg: #4a1e1e;
        --status-danger-border: #d13438;
        --btn-logout-hover: #3a1e1e;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
      }

      /* ========================================
       Reset & Base Styles
       ======================================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* ========================================
       Global Scrollbar Styling - Round & Long
       ======================================== */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
      }

      *::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      *::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 10px;
      }

      *::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
        min-height: 40px;
        transition: background 0.2s ease;
      }

      *::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.35);
        background-clip: padding-box;
      }

      *::-webkit-scrollbar-thumb:active {
        background: rgba(0, 0, 0, 0.5);
        background-clip: padding-box;
      }

      [data-theme="dark"] * {
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
      }

      [data-theme="dark"] *::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        background-clip: padding-box;
      }

      [data-theme="dark"] *::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.35);
        background-clip: padding-box;
      }

      [data-theme="dark"] *::-webkit-scrollbar-thumb:active {
        background: rgba(255, 255, 255, 0.5);
        background-clip: padding-box;
      }

      body {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Inter",
          sans-serif;
        background: var(--bg-main);
        height: 100vh;
        overflow: hidden;
        color: var(--text-primary);
        font-size: 13px;
        line-height: 1.4;
        display: flex;
        flex-direction: column;
      }

      /* ========================================
       Layout - Sidebar, Title Bar, Main
       ======================================== */
      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .title-bar {
        height: 48px;
        background: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0;
        flex-shrink: 0;
        -webkit-app-region: drag;
        user-select: none;
        width: 100%;
      }

      .title-bar-content {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        padding: 0 16px;
        flex: 1;
        -webkit-app-region: drag;
      }

      .title-bar-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        -webkit-app-region: no-drag;
      }

      .window-controls {
        display: flex;
        align-items: center;
        height: 100%;
        -webkit-app-region: no-drag;
      }

      .window-control-btn {
        width: 46px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: background-color 0.15s ease;
        padding: 0;
      }

      .window-control-btn:hover {
        background: var(--bg-hover);
      }

      .window-control-btn.close:hover {
        background: #e81123;
        color: white;
      }

      .window-control-btn svg {
        width: 12px;
        height: 12px;
        fill: currentColor;
      }

      /* Make sure the entire title bar area is draggable including where native controls are */
      .title-bar > * {
        position: relative;
        z-index: 1;
      }

      .theme-toggle {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: var(--text-primary);
        transition: background-color 0.15s ease;
        padding: 0;
      }

      .theme-toggle:hover {
        background: var(--bg-hover);
      }

      .theme-toggle:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      .app-logo {
        width: 20px;
        height: 20px;
        background: var(--primary);
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 11px;
        font-weight: 600;
      }

      .main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* ========================================
       Sidebar Navigation
       ======================================== */
      .sidebar {
        width: 240px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow-y: auto;
      }

      .nav-section {
        padding: 12px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        color: var(--text-primary);
        text-decoration: none;
        font-size: 13px;
        cursor: pointer;
        transition: background-color 0.15s ease;
        border-left: 3px solid transparent;
        user-select: none;
      }

      .nav-item:hover {
        background: var(--bg-hover);
      }

      .nav-item.active {
        background: rgba(0, 120, 212, 0.15);
        border-left-color: var(--primary);
        color: var(--primary);
        font-weight: 500;
      }

      [data-theme="dark"] .nav-item.active {
        background: rgba(0, 120, 212, 0.2);
      }

      .nav-icon {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
      }

      .nav-item.has-submenu {
        justify-content: space-between;
      }

      .nav-chevron {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
        font-size: 10px;
        color: var(--text-secondary);
      }

      .nav-item.expanded .nav-chevron {
        transform: rotate(90deg);
      }

      .nav-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: var(--bg-sidebar);
      }

      .nav-item.expanded + .nav-submenu {
        max-height: 500px;
      }

      .nav-submenu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px 8px 44px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease;
        border-left: 3px solid transparent;
      }

      .nav-submenu-item:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      .nav-submenu-item.active {
        background: rgba(0, 120, 212, 0.1);
        border-left-color: var(--primary);
        color: var(--primary);
        font-weight: 500;
      }

      .sidebar-footer {
        margin-top: auto;
        padding: 16px;
        border-top: 1px solid var(--border-color);
      }

      .user-info {
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 12px;
      }

      .user-email {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 4px;
        word-break: break-all;
      }

      .user-org {
        font-size: 11px;
        color: var(--text-secondary);
      }

      /* ========================================
       Main Content Area
       ======================================== */
      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg-main);
      }

      .content-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }

      /* ========================================
       Statistics Cards
       ======================================== */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 16px;
      }

      .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        padding: 14px;
        display: flex;
        flex-direction: column;
        border-radius: var(--border-radius);
      }

      .stat-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .stat-card-icon {
        font-size: 16px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-hover);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        flex-shrink: 0;
      }

      .stat-card-label {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .stat-card-value {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.1;
        margin-bottom: 4px;
      }

      .stat-card-desc {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: auto;
      }

      /* ========================================
       Connection Status Panel
       ======================================== */
      .connection-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        padding: 16px;
        margin-bottom: 16px;
        border-radius: var(--border-radius);
      }

      .panel-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .panel-title::before {
        content: "";
        width: 3px;
        height: 14px;
        background: var(--primary);
        border-radius: 2px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 500;
        color: var(--text-secondary);
      }

      .info-value {
        color: var(--text-primary);
        font-weight: 400;
        text-align: right;
      }

      .btn-group {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* ========================================
       Sync History Table
       ======================================== */
      .history-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        padding: 16px;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        border-radius: var(--border-radius);
      }

      .table-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
      }

      .table-wrapper {
        flex: 1;
        overflow: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        table-layout: fixed;
      }

      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      th {
        background: var(--bg-hover);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:hover {
        background: var(--bg-hover);
      }

      tbody tr.clickable {
        cursor: pointer;
      }

      tbody tr.clickable:hover {
        background: var(--bg-hover);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .success {
        color: var(--success);
        font-weight: 500;
      }

      .error {
        color: var(--danger);
        font-weight: 500;
      }

      .partial {
        color: var(--warning);
        font-weight: 500;
      }

      /* ========================================
       Buttons & Controls
       ======================================== */
      .btn {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-weight: 400;
        cursor: pointer;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background-color 0.15s ease, border-color 0.15s ease;
        width: 100%;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
      }

      .btn-logout {
        background: var(--bg-card);
        color: var(--danger);
        border-color: var(--danger);
      }

      .btn-logout:hover:not(:disabled) {
        background: var(--btn-logout-hover);
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      /* ========================================
       Status Badges
       ======================================== */
      .status-badge {
        padding: 3px 8px;
        border-radius: var(--border-radius);
        font-weight: 500;
        font-size: 11px;
        display: inline-block;
        border: 1px solid transparent;
      }

      .status-connected {
        background: var(--status-success-bg);
        color: var(--success);
        border-color: var(--status-success-border);
      }

      .status-syncing {
        background: var(--status-warning-bg);
        color: var(--warning);
        border-color: var(--status-warning-border);
      }

      .status-disconnected {
        background: var(--status-danger-bg);
        color: var(--danger);
        border-color: var(--status-danger-border);
      }

      .status-info {
        background: var(--status-success-bg);
        color: var(--primary);
        border-color: var(--status-success-border);
      }

      .status-warn {
        background: var(--status-warning-bg);
        color: var(--warning);
        border-color: var(--status-warning-border);
      }

      .status-error {
        background: var(--status-danger-bg);
        color: var(--danger);
        border-color: var(--status-danger-border);
      }

      .status-debug {
        background: var(--bg-hover);
        color: var(--text-secondary);
        border-color: var(--border-color);
      }

      /* ========================================
       Pagination
       ======================================== */
      .pagination {
        margin-top: 12px;
        display: flex;
        justify-content: center;
        gap: 6px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
      }

      .pagination button {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        background: var(--bg-card);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 400;
        font-size: 12px;
        transition: background-color 0.15s ease;
        color: var(--text-primary);
      }

      .pagination button:hover:not(:disabled) {
        background: var(--bg-hover);
      }

      .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ========================================
       Spinner
       ======================================== */
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ========================================
       Content Views
       ======================================== */
      .content-view {
        display: none;
      }

      .content-view.active {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      /* ========================================
       Filter Panel
       ======================================== */
      .filter-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 150px;
      }

      .filter-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-input,
      .filter-select {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-main);
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
      }

      .filter-input:focus,
      .filter-select:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
        border-color: var(--primary);
      }

      .filter-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
      }

      /* ========================================
       Modal System - Modern Design
       ======================================== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0, 0, 0, 0.05);
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }

      .modal.small {
        width: 420px;
      }

      .modal.medium {
        width: 640px;
      }

      .modal.large {
        width: 960px;
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        background: var(--bg-sidebar);
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius);
        transition: var(--transition);
        font-size: 20px;
        line-height: 1;
      }

      .modal-close:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        transform: scale(1.1);
      }

      .modal-close:active {
        transform: scale(0.95);
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
        background: var(--bg-sidebar);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.96) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      /* ========================================
       API Log Detail Modal
       ======================================== */
      .api-detail-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        height: 500px;
      }

      .api-detail-panel {
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .api-detail-header {
        padding: 10px 12px;
        background: var(--bg-hover);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .api-detail-content {
        flex: 1;
        overflow: auto;
        padding: 12px;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.6;
        background: var(--bg-main);
      }

      .json-key {
        color: var(--primary);
      }

      .json-string {
        color: var(--success);
      }

      .json-number {
        color: var(--warning);
      }

      .json-boolean {
        color: var(--danger);
      }

      /* ========================================
       Settings Page
       ======================================== */
      .settings-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 16px;
        margin-bottom: 16px;
      }

      .settings-section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .settings-row:last-child {
        border-bottom: none;
      }

      .settings-label {
        font-size: 13px;
        color: var(--text-primary);
      }

      .settings-description {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .settings-control {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-switch {
        width: 40px;
        height: 20px;
        background: var(--border-color);
        border-radius: 10px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .toggle-switch.active {
        background: var(--primary);
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.2s ease;
      }

      .toggle-switch.active::after {
        transform: translateX(20px);
      }

      /* ========================================
       Utilities
       ======================================== */
      .hidden {
        display: none;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 13px;
      }

      /* ========================================
       Chart Containers
       ======================================== */
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      canvas {
        max-height: 100%;
      }

      /* ========================================
       Data Table Styles
       ======================================== */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th,
      .data-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .data-table th {
        background: var(--bg-hover);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 1;
        cursor: pointer;
        user-select: none;
      }

      .data-table th:hover {
        background: var(--bg-sidebar);
      }

      .data-table th.sorted {
        color: var(--primary);
      }

      .data-table th .sort-icon {
        margin-left: 4px;
        font-size: 10px;
        opacity: 0.5;
      }

      .data-table tbody tr:hover {
        background: var(--bg-hover);
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* ========================================
       Pagination Styles
       ======================================== */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-top: 1px solid var(--border-color);
        margin-top: 16px;
      }

      .pagination-info {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Custom Title Bar -->
      <div class="title-bar">
        <div class="title-bar-content">
          <div class="app-logo">Z</div>
          <span>Zorrofin Connect</span>
        </div>
        <div class="title-bar-actions">
          <button
            id="themeToggle"
            class="theme-toggle"
            title="Toggle dark/light mode"
            aria-label="Toggle theme"
          >
            <span id="themeIcon"><i class="fas fa-moon"></i></span>
          </button>
          <div class="window-controls">
            <button
              id="minimizeBtn"
              class="window-control-btn"
              title="Minimize"
              aria-label="Minimize"
            >
              <svg viewBox="0 0 12 12">
                <rect x="0" y="5" width="12" height="1" />
              </svg>
            </button>
            <button
              id="maximizeBtn"
              class="window-control-btn"
              title="Maximize"
              aria-label="Maximize"
            >
              <svg
                id="maximizeIcon"
                viewBox="0 0 12 12"
                style="width: 12px; height: 12px"
              >
                <rect
                  x="1"
                  y="1"
                  width="10"
                  height="10"
                  stroke="currentColor"
                  stroke-width="1"
                  fill="none"
                />
              </svg>
            </button>
            <button
              id="closeBtn"
              class="window-control-btn close"
              title="Close"
              aria-label="Close"
            >
              <svg viewBox="0 0 12 12">
                <path
                  d="M1 1 L11 11 M11 1 L1 11"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="main-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
          <nav class="nav-section">
            <div class="nav-item active" data-view="dashboard">
              <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
              <span>Dashboard</span>
            </div>
            <div class="nav-item" data-view="customers">
              <span class="nav-icon"><i class="fas fa-users"></i></span>
              <span>Customers</span>
            </div>
            <div class="nav-item" data-view="vouchers">
              <span class="nav-icon"
                ><i class="fas fa-file-invoice-dollar"></i
              ></span>
              <span>Vouchers</span>
            </div>
            <div class="nav-item" data-view="settings">
              <span class="nav-icon"><i class="fas fa-cog"></i></span>
              <span>Settings</span>
            </div>
            <div class="nav-item has-submenu" id="logsNavItem">
              <span style="display: flex; align-items: center; gap: 12px">
                <span class="nav-icon"><i class="fas fa-list-alt"></i></span>
                <span>Logs</span>
              </span>
              <span class="nav-chevron">â–¶</span>
            </div>
            <div class="nav-submenu">
              <div class="nav-submenu-item" data-view="system-logs">
                <span class="nav-icon"><i class="fas fa-server"></i></span>
                <span>System Logs</span>
              </div>
              <div class="nav-submenu-item" data-view="api-logs">
                <span class="nav-icon"><i class="fas fa-globe"></i></span>
                <span>API Logs</span>
              </div>
              <div class="nav-submenu-item" data-view="voucher-logs">
                <span class="nav-icon"
                  ><i class="fas fa-file-invoice"></i
                ></span>
                <span>Tally Voucher Logs</span>
              </div>
              <div class="nav-submenu-item" data-view="sync-history">
                <span class="nav-icon"><i class="fas fa-history"></i></span>
                <span>Sync History</span>
              </div>
            </div>
          </nav>

          <div class="sidebar-footer">
            <div class="user-info">
              <div class="user-email" id="sidebarEmail">-</div>
              <div class="user-org" id="sidebarOrg">Not synced</div>
            </div>
            <button id="sidebarLogoutBtn" class="btn btn-logout">Logout</button>
          </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area">
          <!-- Dashboard View -->
          <div class="content-view active" id="dashboardView">
            <div class="content-scroll">
              <!-- Statistics Cards -->
              <div class="stats-container">
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div class="stat-card-icon">
                      <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-card-label">Total Syncs</div>
                  </div>
                  <div class="stat-card-value" id="statTotal">0</div>
                  <div class="stat-card-desc">All time sync operations</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div
                      class="stat-card-icon"
                      style="
                        background: var(--success-light);
                        color: var(--success);
                      "
                    >
                      <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-label">Successful</div>
                  </div>
                  <div class="stat-card-value" id="statSuccessful">0</div>
                  <div class="stat-card-desc">Completed successfully</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div
                      class="stat-card-icon"
                      style="
                        background: var(--danger-light);
                        color: var(--danger);
                      "
                    >
                      <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-card-label">Failed</div>
                  </div>
                  <div class="stat-card-value" id="statFailed">0</div>
                  <div class="stat-card-desc">Errors or failures</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div
                      class="stat-card-icon"
                      style="
                        background: var(--warning-light);
                        color: var(--warning);
                      "
                    >
                      <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-card-label">Today's Syncs</div>
                  </div>
                  <div class="stat-card-value" id="statToday">0</div>
                  <div class="stat-card-desc">Syncs performed today</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div
                      class="stat-card-icon"
                      style="background: var(--info-light); color: var(--info)"
                    >
                      <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-label">Total Customers</div>
                  </div>
                  <div class="stat-card-value" id="statCustomers">0</div>
                  <div class="stat-card-desc">Customers in database</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-header">
                    <div
                      class="stat-card-icon"
                      style="
                        background: var(--primary-light);
                        color: var(--primary);
                      "
                    >
                      <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-card-label">Total Vouchers</div>
                  </div>
                  <div class="stat-card-value" id="statVouchers">0</div>
                  <div class="stat-card-desc">Vouchers in database</div>
                </div>
              </div>

              <!-- Connection Status Panel -->
              <div class="connection-panel">
                <h2 class="panel-title">Connection Status</h2>
                <div class="info-row">
                  <span class="info-label">Email</span>
                  <span class="info-value" id="email">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Biller ID</span>
                  <span class="info-value" id="billerId">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Organization</span>
                  <span class="info-value" id="org">Not synced</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Sync Status</span>
                  <span id="status" class="status-badge status-connected"
                    >Connected</span
                  >
                </div>
                <div class="info-row">
                  <span class="info-label">Last Sync</span>
                  <span class="info-value" id="lastSync">Never</span>
                </div>
                <div class="btn-group">
                  <button id="syncBtn" class="btn btn-primary">
                    Manual Sync
                  </button>
                </div>
              </div>

              <!-- Charts Section -->
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 16px;
                  margin-bottom: 16px;
                "
              >
                <!-- Sync Status Chart -->
                <div class="history-panel" style="margin-bottom: 0">
                  <h2 class="panel-title">Sync Status Distribution</h2>
                  <div
                    style="
                      padding: 20px;
                      height: 300px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    "
                  >
                    <canvas id="syncStatusChart"></canvas>
                  </div>
                </div>
                <!-- Entity Distribution Chart -->
                <div class="history-panel" style="margin-bottom: 0">
                  <h2 class="panel-title">Entity Distribution</h2>
                  <div
                    style="
                      padding: 20px;
                      height: 300px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    "
                  >
                    <canvas id="entityDistributionChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Sync Timeline Chart -->
              <div class="history-panel" style="margin-bottom: 16px">
                <h2 class="panel-title">Sync Timeline (Last 7 Days)</h2>
                <div style="padding: 20px; height: 300px">
                  <canvas id="syncTimelineChart"></canvas>
                </div>
              </div>

              <!-- Recent Sync History Panel -->
              <div class="history-panel">
                <h2 class="panel-title">Recent Sync History</h2>
                <div class="table-container">
                  <div class="table-wrapper">
                    <table id="recentSyncHistoryTable">
                      <thead>
                        <tr>
                          <th style="width: 200px">Entity Name</th>
                          <th style="width: 100px">Total Records</th>
                          <th style="width: 120px">Successfully Synced</th>
                          <th style="width: 80px">Failed</th>
                          <th style="width: 150px">Last Sync Time</th>
                          <th style="width: 100px">Status</th>
                        </tr>
                      </thead>
                      <tbody id="recentSyncHistoryTableBody">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Voucher Sync Summary Panel -->
              <div class="history-panel" style="margin-top: 16px">
                <h2 class="panel-title">Voucher Sync Summary</h2>
                <div class="table-container">
                  <div class="table-wrapper">
                    <table id="voucherSummaryTable">
                      <thead>
                        <tr>
                          <th style="width: 150px">Voucher Type</th>
                          <th style="width: 120px">Total Attempted</th>
                          <th style="width: 120px">Successfully Synced</th>
                          <th style="width: 80px">Failed</th>
                        </tr>
                      </thead>
                      <tbody id="voucherSummaryTableBody">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings View -->
          <div class="content-view" id="settingsView">
            <div class="content-scroll">
              <div class="settings-section">
                <h2 class="settings-section-title">Appearance</h2>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Theme</div>
                    <div class="settings-description">
                      Choose light or dark theme
                    </div>
                  </div>
                  <div class="settings-control">
                    <select id="themeSelect" class="filter-select">
                      <option value="light">Light</option>
                      <option value="dark">Dark</option>
                      <option value="auto">Auto (System)</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="settings-section">
                <h2 class="settings-section-title">Sounds</h2>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Enable Sound Effects</div>
                    <div class="settings-description">
                      Play sounds for dialogs and actions
                    </div>
                  </div>
                  <div class="settings-control">
                    <div class="toggle-switch" id="soundToggle"></div>
                  </div>
                </div>
              </div>

              <div class="settings-section">
                <h2 class="settings-section-title">Sync</h2>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">
                      Auto-sync Interval (minutes)
                    </div>
                    <div class="settings-description">
                      How often to automatically sync data
                    </div>
                  </div>
                  <div class="settings-control">
                    <input
                      type="number"
                      id="syncInterval"
                      class="filter-input"
                      min="1"
                      max="1440"
                      value="15"
                      style="width: 80px"
                    />
                  </div>
                </div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Background Sync</div>
                    <div class="settings-description">
                      Enable automatic background synchronization
                    </div>
                  </div>
                  <div class="settings-control">
                    <div
                      class="toggle-switch active"
                      id="backgroundSyncToggle"
                    ></div>
                  </div>
                </div>
              </div>

              <div class="settings-section">
                <h2 class="settings-section-title">API</h2>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">API Endpoint</div>
                    <div class="settings-description">
                      Base URL for API requests
                    </div>
                  </div>
                  <div class="settings-control">
                    <input
                      type="text"
                      id="apiEndpoint"
                      class="filter-input"
                      value=""
                      placeholder="Loading..."
                      style="width: 250px"
                      readonly
                      disabled
                    />
                  </div>
                </div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Request Timeout (seconds)</div>
                    <div class="settings-description">
                      Maximum time to wait for API responses
                    </div>
                  </div>
                  <div class="settings-control">
                    <input
                      type="number"
                      id="apiTimeout"
                      class="filter-input"
                      min="5"
                      max="300"
                      value="30"
                      style="width: 80px"
                    />
                  </div>
                </div>
              </div>

              <div class="settings-section">
                <h2 class="settings-section-title">Logs</h2>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Log Retention (days)</div>
                    <div class="settings-description">
                      How long to keep log entries
                    </div>
                  </div>
                  <div class="settings-control">
                    <input
                      type="number"
                      id="logRetention"
                      class="filter-input"
                      min="1"
                      max="365"
                      value="30"
                      style="width: 80px"
                    />
                  </div>
                </div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">Max Log Entries</div>
                    <div class="settings-description">
                      Maximum number of log entries to store
                    </div>
                  </div>
                  <div class="settings-control">
                    <input
                      type="number"
                      id="maxLogEntries"
                      class="filter-input"
                      min="100"
                      max="100000"
                      value="10000"
                      style="width: 100px"
                    />
                  </div>
                </div>
              </div>

              <div class="settings-section">
                <h2 class="settings-section-title">Export & Clear</h2>
                <div class="btn-group" style="margin-top: 0">
                  <button class="btn btn-primary" id="exportLogsBtn">
                    Export All Logs
                  </button>
                  <button class="btn btn-logout" id="clearAllLogsBtn">
                    Clear All Logs
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- System Logs View -->
          <div class="content-view" id="systemLogsView">
            <div class="content-scroll">
              <div class="filter-panel">
                <div class="filter-group">
                  <label class="filter-label">Level</label>
                  <select id="systemLogLevelFilter" class="filter-select">
                    <option value="">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                  </select>
                </div>
                <div class="filter-group" style="flex: 1; min-width: 200px">
                  <label class="filter-label">Search</label>
                  <input
                    type="text"
                    id="systemLogSearch"
                    class="filter-input"
                    placeholder="Search messages..."
                  />
                </div>
                <div class="filter-actions">
                  <button class="btn btn-primary" id="systemLogRefreshBtn">
                    Refresh
                  </button>
                </div>
              </div>
              <div class="history-panel">
                <h2 class="panel-title">System Logs</h2>
                <div class="table-container">
                  <div class="table-wrapper">
                    <table id="systemLogsTable">
                      <thead>
                        <tr>
                          <th style="width: 150px">Time</th>
                          <th style="width: 80px">Level</th>
                          <th>Message</th>
                        </tr>
                      </thead>
                      <tbody id="systemLogsTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- API Logs View -->
          <div class="content-view" id="apiLogsView">
            <div class="content-scroll">
              <div class="filter-panel">
                <div class="filter-group">
                  <label class="filter-label">Status</label>
                  <select id="apiLogStatusFilter" class="filter-select">
                    <option value="">All</option>
                    <option value="SUCCESS">Success</option>
                    <option value="ERROR">Error</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">From Date</label>
                  <input type="date" id="apiLogFromDate" class="filter-input" />
                </div>
                <div class="filter-group">
                  <label class="filter-label">To Date</label>
                  <input type="date" id="apiLogToDate" class="filter-input" />
                </div>
                <div class="filter-group" style="flex: 1; min-width: 200px">
                  <label class="filter-label">Endpoint</label>
                  <input
                    type="text"
                    id="apiLogEndpointFilter"
                    class="filter-input"
                    placeholder="Filter by endpoint..."
                  />
                </div>
                <div class="filter-actions">
                  <button class="btn btn-primary" id="apiLogRefreshBtn">
                    Refresh
                  </button>
                </div>
              </div>
              <div class="history-panel">
                <h2 class="panel-title">API Logs</h2>
                <div class="table-container">
                  <div class="table-wrapper">
                    <table id="apiLogsTable">
                      <thead>
                        <tr>
                          <th style="width: 150px">Time</th>
                          <th style="width: 80px">Method</th>
                          <th>Endpoint</th>
                          <th style="width: 80px">Status</th>
                          <th style="width: 100px">Duration</th>
                        </tr>
                      </thead>
                      <tbody id="apiLogsTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tally Voucher Logs View -->
          <div class="content-view" id="voucherLogsView">
            <div class="content-scroll">
              <div class="filter-panel">
                <div class="filter-group">
                  <label class="filter-label">Voucher Type</label>
                  <select id="voucherTypeFilter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="sales">Sales</option>
                    <option value="credit_note">Credit Note</option>
                    <option value="receipt">Receipt</option>
                    <option value="RECEIPT">Receipt (Alt)</option>
                    <option value="jv_entry">Journal Entry</option>
                    <option value="JVENTRY">Journal Entry (Alt)</option>
                    <option value="JV">Journal (Alt)</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">Status</label>
                  <select id="voucherStatusFilter" class="filter-select">
                    <option value="">All</option>
                    <option value="SUCCESS">Success</option>
                    <option value="FAILED">Failed</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">From Date</label>
                  <input
                    type="date"
                    id="voucherFromDate"
                    class="filter-input"
                  />
                </div>
                <div class="filter-group">
                  <label class="filter-label">To Date</label>
                  <input type="date" id="voucherToDate" class="filter-input" />
                </div>
                <div class="filter-group" style="flex: 1; min-width: 200px">
                  <label class="filter-label">Search</label>
                  <input
                    type="text"
                    id="voucherSearch"
                    class="filter-input"
                    placeholder="Voucher number or party..."
                  />
                </div>
                <div class="filter-actions">
                  <button class="btn btn-primary" id="voucherLogRefreshBtn">
                    Refresh
                  </button>
                </div>
              </div>
              <div class="history-panel">
                <h2 class="panel-title">Tally Voucher Logs</h2>
                <div class="table-container">
                  <div class="table-wrapper">
                    <table id="voucherLogsTable">
                      <thead>
                        <tr>
                          <th style="width: 100px">Date</th>
                          <th style="width: 120px">Voucher Number</th>
                          <th style="width: 100px">Type</th>
                          <th>Party</th>
                          <th style="width: 100px">Amount</th>
                          <th style="width: 80px">Status</th>
                        </tr>
                      </thead>
                      <tbody id="voucherLogsTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Customers View -->
          <div class="content-view" id="customersView">
            <div class="content-scroll">
              <div class="filter-panel">
                <div class="filter-group" style="flex: 1; min-width: 200px">
                  <label class="filter-label">Search</label>
                  <input
                    type="text"
                    id="customerSearchInput"
                    class="filter-input"
                    placeholder="Search by name, email, phone..."
                  />
                </div>
              </div>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Mobile</th>
                      <th>Company Name</th>
                      <th style="text-align: right">Current Balance</th>
                    </tr>
                  </thead>
                  <tbody id="customersTableBody"></tbody>
                </table>
              </div>
              <div class="pagination-container">
                <div class="pagination-info" id="customersPaginationInfo">
                  Showing 0-0 of 0 customers
                </div>
                <div
                  class="pagination-controls"
                  id="customersPaginationControls"
                ></div>
              </div>
            </div>
          </div>

          <!-- Vouchers View -->
          <div class="content-view" id="vouchersView">
            <div class="content-scroll">
              <div class="filter-panel">
                <div class="filter-group">
                  <label class="filter-label">Voucher Type</label>
                  <select id="voucherTypeFilterView" class="filter-select">
                    <option value="">All Types</option>
                    <option value="invoice">Invoice</option>
                    <option value="receipt">Receipt</option>
                    <option value="journal">Journal</option>
                  </select>
                </div>
                <div class="filter-group" style="flex: 1; min-width: 200px">
                  <label class="filter-label">Search</label>
                  <input
                    type="text"
                    id="voucherSearchInput"
                    class="filter-input"
                    placeholder="Search by voucher number, party..."
                  />
                </div>
              </div>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Voucher Number</th>
                      <th>Type</th>
                      <th>Date</th>
                      <th>Party</th>
                      <th style="text-align: right">Amount</th>
                      <th>API Status</th>
                    </tr>
                  </thead>
                  <tbody id="vouchersTableBody"></tbody>
                </table>
              </div>
              <div class="pagination-container">
                <div class="pagination-info" id="vouchersPaginationInfo">
                  Showing 0-0 of 0 vouchers
                </div>
                <div
                  class="pagination-controls"
                  id="vouchersPaginationControls"
                ></div>
              </div>
            </div>
          </div>

          <!-- Sync History View -->
          <div class="content-view" id="syncHistoryView">
            <div class="content-scroll">
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>Entity</th>
                      <th>Status</th>
                      <th>Count</th>
                      <th>Failed</th>
                      <th>Started</th>
                      <th>Completed</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="syncHistoryTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Modal Overlay -->
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal medium" id="modal">
          <div class="modal-header">
            <span class="modal-title" id="modalTitle">Modal Title</span>
            <button class="modal-close" id="modalClose">Ã—</button>
          </div>
          <div class="modal-body" id="modalBody"></div>
          <div class="modal-footer" id="modalFooter"></div>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // ElectronAPI Availability Check
      // ========================================
      // Check if electronAPI is available - must be done first!
      (function () {
        if (typeof window === "undefined" || !window.electronAPI) {
          console.error("CRITICAL ERROR: window.electronAPI is not available!");
          console.error("The preload script may have failed to load.");
          // Show error message after a short delay to ensure DOM is ready
          setTimeout(() => {
            const body = document.body;
            if (body) {
              body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif; background: #1e1e1e; color: #fff; padding: 20px; text-align: center;">
                  <h1 style="color: #ff6b6b; margin-bottom: 20px; font-size: 24px;">âš ï¸ Error: Application Not Initialized</h1>
                  <p style="margin-bottom: 10px; font-size: 16px;">The application cannot communicate with the main process.</p>
                  <p style="margin-bottom: 20px; color: #888; font-size: 14px;">Please restart the application.</p>
                  <button onclick="location.reload()" style="padding: 12px 24px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">ðŸ”„ Reload Application</button>
                </div>
              `;
            }
          }, 100);
          throw new Error(
            "electronAPI is not available - preload script may have failed"
          );
        }
        console.log("âœ“ electronAPI is available");
        console.log(
          "Available methods:",
          Object.keys(window.electronAPI || {})
        );
      })();

      // ========================================
      // Variable Declarations (must be before functions that use them)
      // ========================================
      let emailEl, billerIdEl, orgEl, statusEl, lastSyncEl, syncBtn, logoutBtn;
      let sidebarEmailEl,
        sidebarOrgEl,
        statTotalEl,
        statSuccessfulEl,
        statFailedEl;
      let statTodayEl, statCustomersEl, statVouchersEl;
      let historyData = [];

      // Chart instances
      let syncStatusChart = null;
      let entityDistributionChart = null;
      let syncTimelineChart = null;

      // ========================================
      // Theme Management
      // ========================================
      const THEME_STORAGE_KEY = "zoroflex-theme";
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");

      // Get system theme preference
      const getSystemTheme = () => {
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          return "dark";
        }
        return "light";
      };

      // Get saved theme from localStorage
      const getSavedTheme = () => {
        return localStorage.getItem(THEME_STORAGE_KEY);
      };

      // Get initial theme (saved > system > light)
      const getInitialTheme = () => {
        const saved = getSavedTheme();
        if (saved === "dark" || saved === "light") {
          return saved;
        }
        return getSystemTheme();
      };

      // Set theme
      const setTheme = (theme) => {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(THEME_STORAGE_KEY, theme);

        // Update icon
        if (themeIcon) {
          themeIcon.innerHTML =
            theme === "dark"
              ? '<i class="fas fa-sun"></i>'
              : '<i class="fas fa-moon"></i>';
        }

        // Update charts when theme changes
        if (
          historyData &&
          (syncStatusChart || entityDistributionChart || syncTimelineChart)
        ) {
          const dashboardStats = {
            totalCustomers: statCustomersEl?.textContent || 0,
            totalVouchers: statVouchersEl?.textContent || 0,
          };
          updateAllCharts(historyData, dashboardStats);
        }
      };

      // Toggle theme
      const toggleTheme = () => {
        const currentTheme =
          document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      };

      // Initialize theme
      const initTheme = () => {
        const theme = getInitialTheme();
        setTheme(theme);
      };

      // Watch system theme changes (only if no user preference)
      const watchSystemTheme = () => {
        if (!window.matchMedia) return;

        const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
        mediaQuery.addEventListener("change", (e) => {
          // Only follow system if user hasn't set a preference
          const saved = getSavedTheme();
          if (!saved || saved === "auto") {
            setTheme(e.matches ? "dark" : "light");
          }
        });
      };

      // Initialize theme on load
      initTheme();
      watchSystemTheme();

      // Theme toggle button click
      if (themeToggle) {
        themeToggle.addEventListener("click", toggleTheme);
      }

      // ========================================
      // Window Controls
      // ========================================
      // Window control elements - will be set in DOMContentLoaded
      let minimizeBtn, maximizeBtn, closeBtn, maximizeIcon;

      // Update maximize icon based on window state
      const updateMaximizeIcon = async () => {
        if (maximizeIcon && window.electronAPI?.isMaximized) {
          try {
            const isMaximized = await window.electronAPI.isMaximized();
            if (isMaximized) {
              // Show restore icon (two overlapping squares)
              maximizeIcon.innerHTML = `
                <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="1" fill="none" />
                <rect x="4" y="4" width="8" height="8" stroke="currentColor" stroke-width="1" fill="none" />
              `;
            } else {
              // Show maximize icon (single square)
              maximizeIcon.innerHTML = `
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="1" fill="none" />
              `;
            }
          } catch (err) {
            console.error("Error updating maximize icon:", err);
          }
        }
      };

      // Window control setup function - will be called in DOMContentLoaded
      const setupWindowControls = () => {
        try {
          minimizeBtn = document.getElementById("minimizeBtn");
          maximizeBtn = document.getElementById("maximizeBtn");
          closeBtn = document.getElementById("closeBtn");
          maximizeIcon = document.getElementById("maximizeIcon");

          console.log("Window control elements found:", {
            minimizeBtn: !!minimizeBtn,
            maximizeBtn: !!maximizeBtn,
            closeBtn: !!closeBtn,
            maximizeIcon: !!maximizeIcon,
            electronAPI: !!window.electronAPI,
          });

          if (!window.electronAPI) {
            console.error(
              "window.electronAPI not available for window controls"
            );
            // Retry after a short delay
            setTimeout(() => {
              if (window.electronAPI) {
                console.log("Retrying window controls setup...");
                setupWindowControls();
              }
            }, 500);
            return;
          }

          // Setup minimize button
          if (minimizeBtn) {
            minimizeBtn.addEventListener("click", () => {
              try {
                if (window.electronAPI?.minimizeWindow) {
                  window.electronAPI.minimizeWindow().catch((err) => {
                    console.error("Error minimizing window:", err);
                  });
                } else {
                  console.error("minimizeWindow function not available");
                }
              } catch (err) {
                console.error("Error in minimize button handler:", err);
              }
            });
            console.log("âœ“ Minimize button handler attached");
          } else {
            console.error("minimizeBtn element not found");
          }

          // Setup maximize/restore button
          if (maximizeBtn) {
            maximizeBtn.addEventListener("click", () => {
              try {
                if (window.electronAPI?.maximizeWindow) {
                  window.electronAPI.maximizeWindow().catch((err) => {
                    console.error("Error maximizing window:", err);
                  });
                  setTimeout(updateMaximizeIcon, 100);
                } else {
                  console.error("maximizeWindow function not available");
                }
              } catch (err) {
                console.error("Error in maximize button handler:", err);
              }
            });
            console.log("âœ“ Maximize button handler attached");
          } else {
            console.error("maximizeBtn element not found");
          }

          // Setup close button
          if (closeBtn) {
            closeBtn.addEventListener("click", () => {
              try {
                if (window.electronAPI?.closeWindow) {
                  window.electronAPI.closeWindow().catch((err) => {
                    console.error("Error closing window:", err);
                  });
                } else {
                  console.error("closeWindow function not available");
                }
              } catch (err) {
                console.error("Error in close button handler:", err);
              }
            });
            console.log("âœ“ Close button handler attached");
          } else {
            console.error("closeBtn element not found");
          }

          // Listen for window state changes
          if (window.electronAPI) {
            try {
              if (window.electronAPI.onWindowMaximize) {
                window.electronAPI.onWindowMaximize(() => {
                  updateMaximizeIcon();
                });
                console.log("âœ“ Window maximize listener attached");
              }

              if (window.electronAPI.onWindowUnmaximize) {
                window.electronAPI.onWindowUnmaximize(() => {
                  updateMaximizeIcon();
                });
                console.log("âœ“ Window unmaximize listener attached");
              }
            } catch (err) {
              console.error("Error setting up window state listeners:", err);
            }
          }

          // Initial icon update
          updateMaximizeIcon();
          console.log("âœ“ Window controls setup completed");
        } catch (err) {
          console.error("Error in setupWindowControls:", err);
        }
      };

      // ========================================
      // Dashboard Functionality
      // ========================================
      // Variables are declared at the top of the script section

      // ========================================
      // Chart Utilities
      // ========================================
      const getChartColors = () => {
        const isDark =
          document.documentElement.getAttribute("data-theme") === "dark";
        return {
          background: isDark ? "#2d2d30" : "#ffffff",
          text: isDark ? "#cccccc" : "#323130",
          border: isDark ? "#3e3e42" : "#e1e1e1",
          primary: "#0078d4",
          success: "#107c10",
          danger: "#d13438",
          warning: "#ffaa44",
          info: "#0078d4",
        };
      };

      const destroyChart = (chart) => {
        if (chart) {
          chart.destroy();
        }
      };

      const initSyncStatusChart = (history) => {
        const canvas = document.getElementById("syncStatusChart");
        if (!canvas) return;

        destroyChart(syncStatusChart);

        const successful = history.filter((h) => h.status === "SUCCESS").length;
        const failed = history.filter(
          (h) => h.status === "FAILED" || h.status === "ERROR"
        ).length;
        const partial = history.filter((h) => h.status === "PARTIAL").length;

        const colors = getChartColors();

        syncStatusChart = new Chart(canvas, {
          type: "doughnut",
          data: {
            labels: ["Success", "Failed", "Partial"],
            datasets: [
              {
                data: [successful, failed, partial],
                backgroundColor: [
                  colors.success,
                  colors.danger,
                  colors.warning,
                ],
                borderColor: colors.background,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: colors.text,
                  padding: 15,
                  font: { size: 12 },
                },
              },
              tooltip: {
                backgroundColor: colors.background,
                titleColor: colors.text,
                bodyColor: colors.text,
                borderColor: colors.border,
                borderWidth: 1,
              },
            },
          },
        });
      };

      const initEntityDistributionChart = (dashboardStats) => {
        const canvas = document.getElementById("entityDistributionChart");
        if (!canvas) return;

        destroyChart(entityDistributionChart);

        const customers = dashboardStats?.totalCustomers || 0;
        const vouchers = dashboardStats?.totalVouchers || 0;

        const colors = getChartColors();

        entityDistributionChart = new Chart(canvas, {
          type: "pie",
          data: {
            labels: ["Customers", "Vouchers"],
            datasets: [
              {
                data: [customers, vouchers],
                backgroundColor: [colors.primary, colors.info],
                borderColor: colors.background,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: colors.text,
                  padding: 15,
                  font: { size: 12 },
                },
              },
              tooltip: {
                backgroundColor: colors.background,
                titleColor: colors.text,
                bodyColor: colors.text,
                borderColor: colors.border,
                borderWidth: 1,
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      };

      const initSyncTimelineChart = (history) => {
        const canvas = document.getElementById("syncTimelineChart");
        if (!canvas) return;

        destroyChart(syncTimelineChart);

        // Get last 7 days
        const days = 7;
        const labels = [];
        const successData = [];
        const failedData = [];

        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          const dayLabel = date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
          labels.push(dayLabel);

          const dayHistory = history.filter((h) => {
            const syncDate = new Date(h.started_at).toISOString().split("T")[0];
            return syncDate === dateStr;
          });

          successData.push(
            dayHistory.filter((h) => h.status === "SUCCESS").length
          );
          failedData.push(
            dayHistory.filter(
              (h) => h.status === "FAILED" || h.status === "ERROR"
            ).length
          );
        }

        const colors = getChartColors();

        syncTimelineChart = new Chart(canvas, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Successful",
                data: successData,
                borderColor: colors.success,
                backgroundColor: colors.success + "20",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Failed",
                data: failedData,
                borderColor: colors.danger,
                backgroundColor: colors.danger + "20",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  color: colors.text,
                  font: { size: 12 },
                },
              },
              tooltip: {
                backgroundColor: colors.background,
                titleColor: colors.text,
                bodyColor: colors.text,
                borderColor: colors.border,
                borderWidth: 1,
              },
            },
            scales: {
              x: {
                ticks: { color: colors.text },
                grid: { color: colors.border },
              },
              y: {
                ticks: { color: colors.text, beginAtZero: true },
                grid: { color: colors.border },
              },
            },
          },
        });
      };

      const updateAllCharts = (history, dashboardStats) => {
        initSyncStatusChart(history);
        initEntityDistributionChart(dashboardStats);
        initSyncTimelineChart(history);
      };

      const formatDate = (dateStr) => {
        if (!dateStr || dateStr === "1970-01-01") return "Never";
        return new Date(dateStr).toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      };

      const isToday = (dateStr) => {
        if (!dateStr) return false;
        const date = new Date(dateStr);
        const today = new Date();
        return (
          date.getDate() === today.getDate() &&
          date.getMonth() === today.getMonth() &&
          date.getFullYear() === today.getFullYear()
        );
      };

      const updateStatistics = (history) => {
        if (!history || history.length === 0) {
          statTotalEl.textContent = "0";
          statSuccessfulEl.textContent = "0";
          statFailedEl.textContent = "0";
          statTodayEl.textContent = "0";
          return;
        }

        const total = history.length;
        const successful = history.filter((h) => h.status === "SUCCESS").length;
        const failed = history.filter(
          (h) =>
            h.status === "FAILED" ||
            h.status === "ERROR" ||
            (h.failed_count && h.failed_count > 0)
        ).length;
        const today = history.filter((h) => isToday(h.started_at)).length;

        if (statTotalEl) statTotalEl.textContent = total;
        if (statSuccessfulEl) statSuccessfulEl.textContent = successful;
        if (statFailedEl) statFailedEl.textContent = failed;
        if (statTodayEl) statTodayEl.textContent = today;
      };

      const loadData = async () => {
        if (!window.electronAPI) {
          console.error("loadData: electronAPI not available");
          return;
        }
        try {
          const [profile, lastSync, history, dashboardStats] =
            await Promise.all([
              window.electronAPI.getProfile(),
              window.electronAPI.getLastSync(),
              window.electronAPI.getSyncHistory(),
              window.electronAPI.getDashboardStats(),
            ]);

          // Profile - Update both main content and sidebar
          if (profile) {
            const email = profile.email || "-";
            const org = profile.organization?.name || "Not synced";

            if (emailEl) emailEl.textContent = email;
            if (sidebarEmailEl) sidebarEmailEl.textContent = email;
            if (billerIdEl) billerIdEl.textContent = profile.biller_id || "N/A";
            if (orgEl) orgEl.textContent = org;
            if (sidebarOrgEl) sidebarOrgEl.textContent = org;
          }

          // Last Sync
          if (lastSyncEl) {
            lastSyncEl.textContent = formatDate(lastSync?.last_successful_sync);
          }

          // History data for statistics
          historyData = Array.isArray(history) ? history : [];

          // Update statistics
          updateStatistics(historyData);

          // Update dashboard stats from SQLite
          if (dashboardStats) {
            if (statCustomersEl)
              statCustomersEl.textContent = dashboardStats.totalCustomers || 0;
            if (statVouchersEl)
              statVouchersEl.textContent = dashboardStats.totalVouchers || 0;
          }

          // Update charts
          updateAllCharts(historyData, dashboardStats);
        } catch (err) {
          console.error("Dashboard load error:", err);
          updateStatistics([]);
        }
      };

      // Button handlers are now set up in DOMContentLoaded event

      // ========================================
      // Recent Sync History
      // ========================================
      async function loadRecentSyncHistory() {
        try {
          const recentHistory = await window.electronAPI.getRecentSyncHistory();
          console.log("Recent sync history loaded:", recentHistory);

          const tbody = document.getElementById("recentSyncHistoryTableBody");

          if (!tbody) {
            console.error("Recent sync history table body not found");
            return;
          }

          tbody.innerHTML = "";

          if (!recentHistory || recentHistory.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon"><i class="fas fa-inbox"></i></div><div class="empty-state-text">No sync history available. Run a sync to see data here.</div></td></tr>';
            return;
          }

          console.log("Rendering recent history items:", recentHistory.length);
          console.log(
            "Recent history data:",
            JSON.stringify(recentHistory, null, 2)
          );

          recentHistory.forEach((item) => {
            if (!item) {
              console.warn("Skipping null item");
              return;
            }

            console.log("Processing item:", item);

            // Ensure values are numbers
            const totalRecords = Number(item.totalRecords) || 0;
            const successCount = Number(item.successCount) || 0;
            const failedCount = Number(item.failedCount) || 0;

            console.log(
              `Item ${item.entityName}: totalRecords=${totalRecords}, successCount=${successCount}, failedCount=${failedCount}`
            );

            const tr = document.createElement("tr");
            tr.classList.add("clickable");
            const statusClass =
              item.status === "SUCCESS"
                ? "success"
                : item.status === "PARTIAL"
                ? "partial"
                : "error";

            tr.innerHTML = `
              <td>${escapeHtml(item.entityName || "N/A")}</td>
              <td>${totalRecords}</td>
              <td>${successCount}</td>
              <td>${failedCount}</td>
              <td>${formatDate(item.lastSyncTime)}</td>
              <td><span class="${statusClass}">${
              item.status || "UNKNOWN"
            }</span></td>
            `;

            tr.addEventListener("click", () => {
              showSyncDetails(
                item.syncHistoryId,
                item.entityType,
                item.entityName
              );
            });

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Failed to load recent sync history:", err);
          const tbody = document.getElementById("recentSyncHistoryTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="color:var(--danger); text-align:center;">Failed to load sync history</td></tr>';
          }
        }
      }

      // ========================================
      // Voucher Sync Summary
      // ========================================
      async function loadVoucherSummary() {
        try {
          const summary = await window.electronAPI.getVoucherSyncSummary();
          console.log("Voucher summary loaded:", summary);

          const tbody = document.getElementById("voucherSummaryTableBody");

          if (!tbody) {
            console.error("Voucher summary table body not found");
            return;
          }

          tbody.innerHTML = "";

          if (!summary || typeof summary !== "object") {
            tbody.innerHTML =
              '<tr><td colspan="4" class="empty-state"><div class="empty-state-icon"><i class="fas fa-file-invoice"></i></div><div class="empty-state-text">No voucher sync data available</div></td></tr>';
            return;
          }

          const voucherTypes = Object.keys(summary);

          if (voucherTypes.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" class="empty-state"><div class="empty-state-icon"><i class="fas fa-file-invoice"></i></div><div class="empty-state-text">No voucher sync data available. Run a voucher sync to see data here.</div></td></tr>';
            return;
          }

          // Sort voucher types for consistent display
          const sortedTypes = voucherTypes.sort();

          sortedTypes.forEach((type) => {
            const data = summary[type];
            if (!data) return;

            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${escapeHtml(type)}</td>
              <td>${data.totalAttempted || 0}</td>
              <td>${data.successCount || 0}</td>
              <td>${data.failedCount || 0}</td>
            `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Failed to load voucher summary:", err);
          const tbody = document.getElementById("voucherSummaryTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="color:var(--danger); text-align:center;">Failed to load voucher summary</td></tr>';
          }
        }
      }

      // ========================================
      // Sync Details Modal
      // ========================================
      async function showSyncDetails(syncHistoryId, entityType, entityName) {
        try {
          // Load sync history record for summary
          const syncHistory = await window.electronAPI.getSyncHistory();
          const syncRecord = syncHistory.find((h) => h.id === syncHistoryId);

          if (!syncRecord) {
            alert("Sync record not found");
            return;
          }

          // Load individual record details
          const recordDetails = await window.electronAPI.getSyncRecordDetails(
            syncHistoryId
          );

          // Build summary section
          const summaryHtml = `
            <div style="padding: 24px; background: linear-gradient(135deg, var(--bg-hover) 0%, var(--bg-card) 100%); border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 24px; box-shadow: var(--shadow-sm);">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Entity Name</div>
                  <div style="font-size: 14px; font-weight: 600;">${escapeHtml(
                    entityName
                  )}</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Last Sync</div>
                  <div style="font-size: 14px;">${formatDate(
                    syncRecord.completed_at || syncRecord.started_at
                  )}</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Records</div>
                  <div style="font-size: 14px; font-weight: 600;">${
                    (syncRecord.entity_count || 0) +
                    (syncRecord.failed_count || 0)
                  }</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status</div>
                  <div><span class="${
                    syncRecord.status === "SUCCESS"
                      ? "success"
                      : syncRecord.status === "PARTIAL"
                      ? "partial"
                      : "error"
                  }">${syncRecord.status}</span></div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Successfully Synced</div>
                  <div style="font-size: 14px; color: var(--success); font-weight: 600;">${
                    syncRecord.entity_count || 0
                  }</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Failed</div>
                  <div style="font-size: 14px; color: var(--danger); font-weight: 600;">${
                    syncRecord.failed_count || 0
                  }</div>
                </div>
              </div>
            </div>
          `;

          // Build filter and search controls
          const controlsHtml = `
            <div class="filter-panel" style="margin-bottom: 16px;">
              <div class="filter-group">
                <label class="filter-label">Status</label>
                <select id="syncDetailStatusFilter" class="filter-select">
                  <option value="">All</option>
                  <option value="SUCCESS">Success</option>
                  <option value="FAILED">Failed</option>
                </select>
              </div>
              <div class="filter-group" style="flex: 1; min-width: 200px;">
                <label class="filter-label">Search</label>
                <input type="text" id="syncDetailSearch" class="filter-input" placeholder="Search by ID or name...">
              </div>
            </div>
          `;

          // Build records table
          let recordsTableHtml = "";
          if (recordDetails.length === 0) {
            recordsTableHtml =
              '<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-inbox"></i></div><div class="empty-state-text">No individual record details available</div></div>';
          } else {
            recordsTableHtml = `
              <div class="table-container" style="max-height: 400px;">
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th style="width: 150px;">Record ID</th>
                        <th>Name</th>
                        <th style="width: 150px;">Synced At</th>
                        <th style="width: 100px;">Status</th>
                        <th>Error Message</th>
                      </tr>
                    </thead>
                    <tbody id="syncDetailRecordsBody">
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }

          const content = summaryHtml + controlsHtml + recordsTableHtml;

          ModalService.open(
            `Sync Details: ${escapeHtml(entityName)}`,
            content,
            "large",
            null,
            "fa-list-alt"
          );

          // Render records table
          if (recordDetails.length > 0) {
            renderSyncDetailRecords(recordDetails);

            // Setup filters
            document
              .getElementById("syncDetailStatusFilter")
              ?.addEventListener("change", () => {
                renderSyncDetailRecords(recordDetails);
              });

            document.getElementById("syncDetailSearch")?.addEventListener(
              "input",
              debounce(() => {
                renderSyncDetailRecords(recordDetails);
              }, 300)
            );
          }

          SoundService.play("dialog");
        } catch (err) {
          console.error("Failed to load sync details:", err);
          SoundService.play("error");
          alert("Failed to load sync details");
        }
      }

      function renderSyncDetailRecords(allRecords) {
        const tbody = document.getElementById("syncDetailRecordsBody");
        if (!tbody) return;

        const statusFilter =
          document.getElementById("syncDetailStatusFilter")?.value || "";
        const searchTerm = (
          document.getElementById("syncDetailSearch")?.value || ""
        ).toLowerCase();

        let filtered = allRecords.filter((record) => {
          if (statusFilter && record.status !== statusFilter) return false;
          if (
            searchTerm &&
            !record.record_id.toLowerCase().includes(searchTerm) &&
            !record.record_name.toLowerCase().includes(searchTerm)
          )
            return false;
          return true;
        });

        tbody.innerHTML = "";

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="empty-state"><div class="empty-state-text">No records match the filters</div></td></tr>';
          return;
        }

        filtered.forEach((record) => {
          const tr = document.createElement("tr");
          const statusClass = record.status === "SUCCESS" ? "success" : "error";

          tr.innerHTML = `
            <td style="font-family: monospace; font-size: 11px;">${escapeHtml(
              record.record_id
            )}</td>
            <td>${escapeHtml(record.record_name)}</td>
            <td>${formatDate(record.synced_at)}</td>
            <td><span class="${statusClass}">${record.status}</span></td>
            <td style="font-size: 11px; color: var(--text-secondary);">${
              record.error_message ? escapeHtml(record.error_message) : "-"
            }</td>
          `;

          tbody.appendChild(tr);
        });
      }

      // ========================================
      // Load Customers
      // ========================================
      let customersData = [];
      let customersCurrentPage = 1;
      let customersPageSize = 50;
      let customersSortColumn = "name";
      let customersSortDirection = "asc";
      let customersTotal = 0;

      const formatCurrency = (value) => {
        const num = parseFloat(value) || 0;
        return (
          "â‚¹" +
          num.toLocaleString("en-IN", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      };

      const sortCustomers = (data, column, direction) => {
        return [...data].sort((a, b) => {
          let aVal = a[column] || "";
          let bVal = b[column] || "";

          if (column === "current_balance") {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          } else {
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
          }

          if (direction === "asc") {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
          } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          }
        });
      };

      const renderCustomersTable = (customers) => {
        const tbody = document.getElementById("customersTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!customers || customers.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state"><div class="empty-state-text">No customers found</div></td></tr>';
          return;
        }

        // Sort data
        const sortedData = sortCustomers(
          customers,
          customersSortColumn,
          customersSortDirection
        );

        // Apply pagination
        const start = (customersCurrentPage - 1) * customersPageSize;
        const end = start + customersPageSize;
        const paginatedData = sortedData.slice(start, end);

        paginatedData.forEach((customer) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(customer.name || "")}</td>
            <td>${escapeHtml(customer.email || "")}</td>
            <td>${escapeHtml(customer.phone || "")}</td>
            <td>${escapeHtml(customer.mobile || "")}</td>
            <td>${escapeHtml(customer.company_name || "")}</td>
            <td style="text-align: right;">${formatCurrency(
              customer.current_balance || 0
            )}</td>
          `;
          tbody.appendChild(tr);
        });

        // Update pagination controls
        updateCustomersPagination();
      };

      const updateCustomersPagination = () => {
        const paginationInfo = document.getElementById(
          "customersPaginationInfo"
        );
        const paginationControls = document.getElementById(
          "customersPaginationControls"
        );

        if (paginationInfo) {
          const start = (customersCurrentPage - 1) * customersPageSize + 1;
          const end = Math.min(
            customersCurrentPage * customersPageSize,
            customersTotal || customersData.length
          );
          paginationInfo.textContent = `Showing ${start}-${end} of ${
            customersTotal || customersData.length
          } customers`;
        }

        if (paginationControls) {
          const totalPages = Math.ceil(
            (customersTotal || customersData.length) / customersPageSize
          );
          paginationControls.innerHTML = `
            <button class="btn" ${
              customersCurrentPage === 1 ? "disabled" : ""
            } onclick="customersPreviousPage()">Previous</button>
            <span style="padding: 0 12px;">Page ${customersCurrentPage} of ${
            totalPages || 1
          }</span>
            <button class="btn" ${
              customersCurrentPage >= totalPages ? "disabled" : ""
            } onclick="customersNextPage()">Next</button>
          `;
        }
      };

      window.customersPreviousPage = () => {
        if (customersCurrentPage > 1) {
          customersCurrentPage--;
          renderCustomersTable(customersData);
        }
      };

      window.customersNextPage = () => {
        const totalPages = Math.ceil(
          (customersTotal || customersData.length) / customersPageSize
        );
        if (customersCurrentPage < totalPages) {
          customersCurrentPage++;
          renderCustomersTable(customersData);
        }
      };

      const setupCustomersTableSorting = () => {
        const headers = document.querySelectorAll(
          "#customersView .data-table th"
        );
        headers.forEach((header, index) => {
          const columns = [
            "name",
            "email",
            "phone",
            "mobile",
            "company_name",
            "current_balance",
          ];
          if (columns[index]) {
            header.style.cursor = "pointer";
            header.addEventListener("click", () => {
              if (customersSortColumn === columns[index]) {
                customersSortDirection =
                  customersSortDirection === "asc" ? "desc" : "asc";
              } else {
                customersSortColumn = columns[index];
                customersSortDirection = "asc";
              }

              // Update sort indicators
              headers.forEach((h) => {
                h.classList.remove("sorted");
                const icon = h.querySelector(".sort-icon");
                if (icon) icon.remove();
              });
              header.classList.add("sorted");
              const icon = document.createElement("span");
              icon.className = "sort-icon";
              icon.textContent = customersSortDirection === "asc" ? "â–²" : "â–¼";
              header.appendChild(icon);

              renderCustomersTable(customersData);
            });
          }
        });
      };

      async function loadCustomers() {
        try {
          const search =
            document.getElementById("customerSearchInput")?.value || "";
          const result = await window.electronAPI.getCustomers(
            customersPageSize * 10, // Load more for client-side pagination
            0,
            search
          );

          console.log("Customers API result:", result);
          customersData = result.customers || [];
          customersTotal = result.total || 0;
          customersCurrentPage = 1;

          if (customersData.length > 0) {
            console.log("Sample customer data:", customersData[0]);
          }

          renderCustomersTable(customersData);
          setupCustomersTableSorting();
        } catch (err) {
          console.error("Failed to load customers:", err);
          const tbody = document.getElementById("customersTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state"><div class="empty-state-text" style="color: var(--danger);">Failed to load customers: ' +
              escapeHtml(err.message || String(err)) +
              "</div></td></tr>";
          }
        }
      }

      // Search input handler for customers
      const customerSearchInput = document.getElementById(
        "customerSearchInput"
      );
      if (customerSearchInput) {
        let searchTimeout;
        customerSearchInput.addEventListener("input", () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadCustomers();
          }, 500);
        });
      }

      // ========================================
      // Load Vouchers
      // ========================================
      let vouchersData = [];
      let vouchersCurrentPage = 1;
      let vouchersPageSize = 50;
      let vouchersSortColumn = "date";
      let vouchersSortDirection = "desc";
      let vouchersTotal = 0;

      const sortVouchers = (data, column, direction) => {
        return [...data].sort((a, b) => {
          let aVal = a[column] || "";
          let bVal = b[column] || "";

          // Handle date field
          if (column === "date") {
            aVal = new Date(aVal).getTime() || 0;
            bVal = new Date(bVal).getTime() || 0;
          }
          // Handle total field
          else if (column === "total") {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          }
          // Handle Customer name (nested)
          else if (column === "customer_name") {
            aVal = String(a.Customer?.name || "").toLowerCase();
            bVal = String(b.Customer?.name || "").toLowerCase();
          } else {
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
          }

          if (direction === "asc") {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
          } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          }
        });
      };

      const renderVouchersTable = (vouchers) => {
        const tbody = document.getElementById("vouchersTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!vouchers || vouchers.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state"><div class="empty-state-text">No vouchers found</div></td></tr>';
          return;
        }

        // Sort data
        const sortedData = sortVouchers(
          vouchers,
          vouchersSortColumn,
          vouchersSortDirection
        );

        // Apply pagination
        const start = (vouchersCurrentPage - 1) * vouchersPageSize;
        const end = start + vouchersPageSize;
        const paginatedData = sortedData.slice(start, end);

        paginatedData.forEach((voucher) => {
          const tr = document.createElement("tr");
          // TallyInvoice doesn't have synced_to_api field - all are synced
          const apiStatus = '<span class="success">Synced</span>';
          // Handle date - could be DateTime object or ISO string
          const voucherDate = voucher.date
            ? typeof voucher.date === "string"
              ? voucher.date
              : voucher.date.toISOString()
            : "";

          tr.innerHTML = `
            <td>${escapeHtml(voucher.invoice_number || "")}</td>
            <td>${escapeHtml(voucher.type || "invoice")}</td>
            <td>${formatDate(voucherDate)}</td>
            <td>${escapeHtml(voucher.Customer?.name || "")}</td>
            <td style="text-align: right;">${formatCurrency(
              voucher.total || 0
            )}</td>
            <td>${apiStatus}</td>
          `;
          tbody.appendChild(tr);
        });

        // Update pagination controls
        updateVouchersPagination();
      };

      const updateVouchersPagination = () => {
        const paginationInfo = document.getElementById(
          "vouchersPaginationInfo"
        );
        const paginationControls = document.getElementById(
          "vouchersPaginationControls"
        );

        if (paginationInfo) {
          const start = (vouchersCurrentPage - 1) * vouchersPageSize + 1;
          const end = Math.min(
            vouchersCurrentPage * vouchersPageSize,
            vouchersTotal || vouchersData.length
          );
          paginationInfo.textContent = `Showing ${start}-${end} of ${
            vouchersTotal || vouchersData.length
          } vouchers`;
        }

        if (paginationControls) {
          const totalPages = Math.ceil(
            (vouchersTotal || vouchersData.length) / vouchersPageSize
          );
          paginationControls.innerHTML = `
            <button class="btn" ${
              vouchersCurrentPage === 1 ? "disabled" : ""
            } onclick="vouchersPreviousPage()">Previous</button>
            <span style="padding: 0 12px;">Page ${vouchersCurrentPage} of ${
            totalPages || 1
          }</span>
            <button class="btn" ${
              vouchersCurrentPage >= totalPages ? "disabled" : ""
            } onclick="vouchersNextPage()">Next</button>
          `;
        }
      };

      window.vouchersPreviousPage = () => {
        if (vouchersCurrentPage > 1) {
          vouchersCurrentPage--;
          renderVouchersTable(vouchersData);
        }
      };

      window.vouchersNextPage = () => {
        const totalPages = Math.ceil(
          (vouchersTotal || vouchersData.length) / vouchersPageSize
        );
        if (vouchersCurrentPage < totalPages) {
          vouchersCurrentPage++;
          renderVouchersTable(vouchersData);
        }
      };

      const setupVouchersTableSorting = () => {
        const headers = document.querySelectorAll(
          "#vouchersView .data-table th"
        );
        headers.forEach((header, index) => {
          const columns = [
            "invoice_number",
            "type",
            "date",
            "customer_name",
            "total",
            "",
          ];
          if (columns[index]) {
            header.style.cursor = "pointer";
            header.addEventListener("click", () => {
              if (vouchersSortColumn === columns[index]) {
                vouchersSortDirection =
                  vouchersSortDirection === "asc" ? "desc" : "asc";
              } else {
                vouchersSortColumn = columns[index];
                vouchersSortDirection = "asc";
              }

              // Update sort indicators
              headers.forEach((h) => {
                h.classList.remove("sorted");
                const icon = h.querySelector(".sort-icon");
                if (icon) icon.remove();
              });
              header.classList.add("sorted");
              const icon = document.createElement("span");
              icon.className = "sort-icon";
              icon.textContent = vouchersSortDirection === "asc" ? "â–²" : "â–¼";
              header.appendChild(icon);

              renderVouchersTable(vouchersData);
            });
          }
        });
      };

      async function loadVouchers() {
        try {
          const search =
            document.getElementById("voucherSearchInput")?.value || "";
          const voucherType =
            document.getElementById("voucherTypeFilterView")?.value || "";
          const result = await window.electronAPI.getVouchers(
            vouchersPageSize * 10, // Load more for client-side pagination
            0,
            search,
            voucherType
          );

          console.log("Vouchers API result:", result);
          vouchersData = result.vouchers || [];
          vouchersTotal = result.total || 0;
          vouchersCurrentPage = 1;

          if (vouchersData.length > 0) {
            console.log("Sample voucher data:", vouchersData[0]);
          }

          renderVouchersTable(vouchersData);
          setupVouchersTableSorting();
        } catch (err) {
          console.error("Failed to load vouchers:", err);
          const tbody = document.getElementById("vouchersTableBody");
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state"><div class="empty-state-text" style="color: var(--danger);">Failed to load vouchers: ' +
              escapeHtml(err.message || String(err)) +
              "</div></td></tr>";
          }
        }
      }

      // Search and filter handlers will be set up in DOMContentLoaded

      // ========================================
      // Load Sync History
      // ========================================
      async function loadSyncHistory() {
        try {
          const history = await window.electronAPI.getSyncHistoryWithBatches(
            50
          );
          const tbody = document.getElementById("syncHistoryTableBody");
          if (!tbody) return;

          tbody.innerHTML = "";
          if (!history || history.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="empty-state"><div class="empty-state-text">No sync history found</div></td></tr>';
            return;
          }

          history.forEach((item) => {
            const tr = document.createElement("tr");
            const statusClass =
              item.status === "SUCCESS"
                ? "success"
                : item.status === "PARTIAL"
                ? "partial"
                : "error";
            const batchCount = item.batches ? item.batches.length : 0;
            tr.innerHTML = `
              <td>${escapeHtml(item.sync_type || "")}</td>
              <td>${escapeHtml(item.entity_type || "")}</td>
              <td><span class="${statusClass}">${escapeHtml(
              item.status || ""
            )}</span></td>
              <td>${item.entity_count || 0}</td>
              <td>${item.failed_count || 0}</td>
              <td>${formatDate(item.started_at)}</td>
              <td>${
                item.completed_at ? formatDate(item.completed_at) : "-"
              }</td>
              <td>${batchCount} batches</td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Failed to load sync history:", err);
        }
      }

      // Initial load - ALL DOM-dependent code must be here
      window.addEventListener("DOMContentLoaded", () => {
        console.log(
          "DOMContentLoaded - electronAPI available:",
          !!window.electronAPI
        );

        // Get all DOM elements NOW that DOM is loaded
        emailEl = document.getElementById("email");
        billerIdEl = document.getElementById("billerId");
        orgEl = document.getElementById("org");
        statusEl = document.getElementById("status");
        lastSyncEl = document.getElementById("lastSync");
        syncBtn = document.getElementById("syncBtn");
        logoutBtn = document.getElementById("sidebarLogoutBtn");
        sidebarEmailEl = document.getElementById("sidebarEmail");
        sidebarOrgEl = document.getElementById("sidebarOrg");
        statTotalEl = document.getElementById("statTotal");
        statSuccessfulEl = document.getElementById("statSuccessful");
        statFailedEl = document.getElementById("statFailed");
        statTodayEl = document.getElementById("statToday");
        statCustomersEl = document.getElementById("statCustomers");
        statVouchersEl = document.getElementById("statVouchers");

        console.log("DOM elements found:", {
          syncBtn: !!syncBtn,
          logoutBtn: !!logoutBtn,
          statusEl: !!statusEl,
          emailEl: !!emailEl,
        });

        // Setup window controls
        if (typeof setupWindowControls === "function") {
          setupWindowControls();
        }

        // Setup button handlers now that elements exist
        if (syncBtn && window.electronAPI) {
          syncBtn.onclick = async () => {
            if (!window.electronAPI) {
              console.error("electronAPI not available for sync");
              alert(
                "Error: Application not properly initialized. Please restart."
              );
              return;
            }
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span class="spinner"></span> Syncing...';
            if (statusEl) {
              statusEl.textContent = "Syncing...";
              statusEl.className = "status-badge status-syncing";
            }
            try {
              await window.electronAPI.manualSync();
            } catch (err) {
              console.error("Manual sync failed:", err);
              alert("Sync failed: " + (err.message || String(err)));
            } finally {
              setTimeout(() => {
                loadData();
                loadRecentSyncHistory();
                loadVoucherSummary();
                syncBtn.disabled = false;
                syncBtn.innerHTML = "Manual Sync";
                if (statusEl) {
                  statusEl.textContent = "Connected";
                  statusEl.className = "status-badge status-connected";
                }
              }, 1000);
            }
          };
          console.log("âœ“ Sync button handler attached");
        } else {
          console.error("syncBtn not found or electronAPI not available:", {
            syncBtn: !!syncBtn,
            electronAPI: !!window.electronAPI,
          });
        }

        if (logoutBtn && window.electronAPI) {
          logoutBtn.onclick = async () => {
            if (
              confirm("Are you sure you want to logout? All sync will stop.")
            ) {
              try {
                await window.electronAPI.logout();
              } catch (err) {
                console.error("Logout failed:", err);
                alert("Logout failed: " + (err.message || String(err)));
              }
            }
          };
          console.log("âœ“ Logout button handler attached");
        } else {
          console.error("logoutBtn not found or electronAPI not available:", {
            logoutBtn: !!logoutBtn,
            electronAPI: !!window.electronAPI,
          });
        }

        // Setup Navigation System
        const logsNavItem = document.getElementById("logsNavItem");
        const navItems = document.querySelectorAll(
          ".nav-item[data-view], .nav-submenu-item[data-view]"
        );
        const contentViews = document.querySelectorAll(".content-view");

        // Ensure all views are initially hidden except dashboard
        contentViews.forEach((cv) => {
          if (!cv.id.includes("dashboard")) {
            cv.classList.remove("active");
          }
        });

        // Expand/collapse logs submenu
        if (logsNavItem) {
          logsNavItem.addEventListener("click", (e) => {
            e.stopPropagation();
            logsNavItem.classList.toggle("expanded");
          });
        }

        // Navigation handler
        navItems.forEach((item) => {
          item.addEventListener("click", () => {
            const view = item.getAttribute("data-view");
            if (!view) return;

            // If clicking a submenu item, ensure parent is expanded
            if (item.classList.contains("nav-submenu-item") && logsNavItem) {
              logsNavItem.classList.add("expanded");
            }

            // Update active states
            navItems.forEach((ni) => ni.classList.remove("active"));
            item.classList.add("active");

            // Show corresponding view
            contentViews.forEach((cv) => cv.classList.remove("active"));

            // Convert hyphenated view names to camelCase for ID matching
            const viewIdMap = {
              dashboard: "dashboardView",
              customers: "customersView",
              vouchers: "vouchersView",
              settings: "settingsView",
              "system-logs": "systemLogsView",
              "api-logs": "apiLogsView",
              "voucher-logs": "voucherLogsView",
              "sync-history": "syncHistoryView",
            };

            const viewId = viewIdMap[view] || `${view}View`;
            const targetView = document.getElementById(viewId);

            if (targetView) {
              targetView.classList.add("active");
              // Load data for the view
              if (view === "system-logs") loadSystemLogs();
              else if (view === "api-logs") loadApiLogs();
              else if (view === "voucher-logs") loadVoucherLogs();
              else if (view === "settings") loadSettings();
              else if (view === "customers") loadCustomers();
              else if (view === "vouchers") loadVouchers();
              else if (view === "sync-history") loadSyncHistory();
            } else {
              console.error(`View not found: ${viewId}`);
            }
          });
        });

        // Setup search and filter handlers for vouchers
        const voucherSearchInput =
          document.getElementById("voucherSearchInput");
        const voucherTypeFilterView = document.getElementById(
          "voucherTypeFilterView"
        );
        if (voucherSearchInput) {
          let searchTimeout;
          voucherSearchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              loadVouchers();
            }, 500);
          });
        }
        if (voucherTypeFilterView) {
          voucherTypeFilterView.addEventListener("change", () => {
            loadVouchers();
          });
        }

        // Load initial data
        if (window.electronAPI) {
          loadData();
          loadRecentSyncHistory();
          loadVoucherSummary();
        } else {
          console.error("electronAPI not available on DOMContentLoaded");
        }

        // Real-time updates - Set up event listeners inside DOMContentLoaded
        if (window.electronAPI) {
          try {
            // Sync started listener
            window.electronAPI.onSyncStarted?.(() => {
              if (statusEl) {
                statusEl.textContent = "Syncing...";
                statusEl.className = "status-badge status-syncing";
              }
            });

            // Sync completed listener
            window.electronAPI.onSyncCompleted?.(() => {
              loadData();
              loadRecentSyncHistory();
              loadVoucherSummary();
              // Update charts when sync completes
              if (historyData) {
                updateAllCharts(historyData, null);
              }
              if (statusEl) {
                statusEl.textContent = "Connected";
                statusEl.className = "status-badge status-connected";
              }
            });

            // Profile data listener
            window.electronAPI.onProfileData?.(() => {
              loadData();
              loadRecentSyncHistory();
              loadVoucherSummary();
            });

            console.log("âœ“ Real-time event listeners set up");
          } catch (err) {
            console.error("Error setting up real-time event listeners:", err);
          }
        } else {
          console.error("electronAPI not available for real-time updates");
        }
      });

      // Navigation System is now set up in DOMContentLoaded

      // ========================================
      // Sound System
      // ========================================
      const SoundService = {
        enabled: true,
        audioContext: null,

        init() {
          try {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          } catch (e) {
            console.warn("Web Audio API not supported");
          }
        },

        async play(type) {
          if (!this.enabled || !this.audioContext) return;

          const frequencies = {
            dialog: 800,
            success: 1000,
            error: 400,
            warning: 600,
          };

          const freq = frequencies[type] || 800;
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.1
          );

          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + 0.1);
        },

        setEnabled(enabled) {
          this.enabled = enabled;
        },
      };

      SoundService.init();

      // ========================================
      // Modal System
      // ========================================
      const modalOverlay = document.getElementById("modalOverlay");
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      const modalFooter = document.getElementById("modalFooter");
      const modalClose = document.getElementById("modalClose");

      let modalFocusTrap = null;

      const ModalService = {
        open(
          title,
          content,
          size = "medium",
          footer = null,
          icon = "fa-info-circle"
        ) {
          modalTitle.innerHTML = `
            <i class="fas ${icon}" style="font-size: 16px; opacity: 0.7; color: var(--primary); margin-right: 8px;"></i>
            <span>${escapeHtml(title)}</span>
          `;
          modalBody.innerHTML = content;
          modal.className = `modal ${size}`;

          if (footer) {
            modalFooter.innerHTML = footer;
            modalFooter.style.display = "flex";
          } else {
            modalFooter.style.display = "none";
          }

          modalOverlay.classList.add("active");
          SoundService.play("dialog");

          // Focus trap
          const focusableElements = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
          );
          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          const trapFocus = (e) => {
            if (e.key === "Tab") {
              if (e.shiftKey) {
                if (document.activeElement === firstElement) {
                  e.preventDefault();
                  lastElement.focus();
                }
              } else {
                if (document.activeElement === lastElement) {
                  e.preventDefault();
                  firstElement.focus();
                }
              }
            }
          };

          modal.addEventListener("keydown", trapFocus);
          modalFocusTrap = trapFocus;

          if (firstElement) firstElement.focus();
        },

        close() {
          modalOverlay.classList.remove("active");
          if (modalFocusTrap) {
            modal.removeEventListener("keydown", modalFocusTrap);
            modalFocusTrap = null;
          }
        },
      };

      modalClose.addEventListener("click", () => ModalService.close());
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) ModalService.close();
      });

      // ESC to close
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalOverlay.classList.contains("active")) {
          ModalService.close();
        }
      });

      // ========================================
      // System Logs
      // ========================================
      let systemLogsData = [];

      async function loadSystemLogs() {
        try {
          const logs = await window.electronAPI.getLogs(500);
          systemLogsData = logs || [];
          renderSystemLogs();
        } catch (err) {
          console.error("Failed to load system logs:", err);
        }
      }

      function renderSystemLogs() {
        const tbody = document.getElementById("systemLogsTableBody");
        const levelFilter = document.getElementById(
          "systemLogLevelFilter"
        ).value;
        const searchTerm = document
          .getElementById("systemLogSearch")
          .value.toLowerCase();

        let filtered = systemLogsData.filter((log) => {
          if (levelFilter && log.level !== levelFilter) return false;
          if (searchTerm && !log.message.toLowerCase().includes(searchTerm))
            return false;
          return true;
        });

        tbody.innerHTML = "";

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><div class="empty-state-text">No logs found</div></td></tr>';
          return;
        }

        filtered.forEach((log) => {
          const tr = document.createElement("tr");
          const levelClass = log.level.toLowerCase();
          tr.innerHTML = `
            <td>${formatDate(log.created_at)}</td>
            <td><span class="status-badge status-${levelClass}">${
            log.level
          }</span></td>
            <td>${escapeHtml(log.message)}</td>
          `;
          tr.style.cursor = "pointer";
          tr.addEventListener("click", () => {
            const metadata = log.metadata
              ? JSON.stringify(log.metadata, null, 2)
              : "No metadata";
            ModalService.open(
              "Log Details",
              `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${escapeHtml(
                metadata
              )}</pre>`,
              "small",
              null,
              "fa-file-alt"
            );
          });
          tbody.appendChild(tr);
        });
      }

      document
        .getElementById("systemLogLevelFilter")
        .addEventListener("change", renderSystemLogs);
      document
        .getElementById("systemLogSearch")
        .addEventListener("input", debounce(renderSystemLogs, 300));
      document
        .getElementById("systemLogRefreshBtn")
        .addEventListener("click", loadSystemLogs);

      // ========================================
      // API Logs
      // ========================================
      let apiLogsData = [];

      async function loadApiLogs() {
        try {
          const statusFilter =
            document.getElementById("apiLogStatusFilter").value;
          const fromDate = document.getElementById("apiLogFromDate").value;
          const toDate = document.getElementById("apiLogToDate").value;
          const endpointFilter = document.getElementById(
            "apiLogEndpointFilter"
          ).value;

          const filters = {};
          if (statusFilter) filters.status = statusFilter;
          if (fromDate) filters.fromDate = fromDate;
          if (toDate) filters.toDate = toDate;
          if (endpointFilter) filters.endpoint = endpointFilter;
          filters.limit = 200;

          const logs = await window.electronAPI.getApiLogs(filters);
          apiLogsData = logs || [];
          renderApiLogs();
        } catch (err) {
          console.error("Failed to load API logs:", err);
        }
      }

      function renderApiLogs() {
        const tbody = document.getElementById("apiLogsTableBody");
        tbody.innerHTML = "";

        if (apiLogsData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ðŸŒ</div><div class="empty-state-text">No API logs found</div></td></tr>';
          return;
        }

        apiLogsData.forEach((log) => {
          const tr = document.createElement("tr");
          const statusClass = log.status === "SUCCESS" ? "success" : "error";
          tr.innerHTML = `
            <td>${formatDate(log.created_at)}</td>
            <td>${log.method}</td>
            <td style="font-family: monospace; font-size: 11px;">${escapeHtml(
              log.endpoint
            )}</td>
            <td><span class="${statusClass}">${
            log.status_code || "N/A"
          }</span></td>
            <td>${log.duration_ms}ms</td>
          `;
          tr.style.cursor = "pointer";
          tr.addEventListener("click", () => {
            showApiLogDetail(log);
          });
          tbody.appendChild(tr);
        });
      }

      function showApiLogDetail(log) {
        const requestJson =
          typeof log.request_payload === "string"
            ? log.request_payload
            : JSON.stringify(log.request_payload, null, 2);
        const responseJson =
          typeof log.response_payload === "string"
            ? log.response_payload
            : JSON.stringify(log.response_payload, null, 2);

        const requestId = "req-" + Date.now();
        const responseId = "res-" + Date.now();

        const content = `
          <div class="api-detail-container">
            <div class="api-detail-panel">
              <div class="api-detail-header">
                <span>Request</span>
                <button class="btn" style="padding: 4px 8px; font-size: 11px;" data-copy="${requestId}">Copy</button>
              </div>
              <div class="api-detail-content" id="${requestId}">${syntaxHighlight(
          requestJson
        )}</div>
            </div>
            <div class="api-detail-panel">
              <div class="api-detail-header">
                <span>Response</span>
                <button class="btn" style="padding: 4px 8px; font-size: 11px;" data-copy="${responseId}">Copy</button>
              </div>
              <div class="api-detail-content" id="${responseId}">${syntaxHighlight(
          responseJson
        )}</div>
            </div>
          </div>
        `;

        ModalService.open(
          "API Request Details",
          content,
          "large",
          null,
          "fa-code"
        );

        // Setup copy buttons
        setTimeout(() => {
          const requestBtn = modal.querySelector(`[data-copy="${requestId}"]`);
          const responseBtn = modal.querySelector(
            `[data-copy="${responseId}"]`
          );

          if (requestBtn) {
            requestBtn.addEventListener("click", () =>
              copyToClipboard(requestJson)
            );
          }
          if (responseBtn) {
            responseBtn.addEventListener("click", () =>
              copyToClipboard(responseJson)
            );
          }
        }, 100);
      }

      document
        .getElementById("apiLogStatusFilter")
        .addEventListener("change", loadApiLogs);
      document
        .getElementById("apiLogFromDate")
        .addEventListener("change", loadApiLogs);
      document
        .getElementById("apiLogToDate")
        .addEventListener("change", loadApiLogs);
      document
        .getElementById("apiLogEndpointFilter")
        .addEventListener("input", debounce(loadApiLogs, 300));
      document
        .getElementById("apiLogRefreshBtn")
        .addEventListener("click", loadApiLogs);

      // ========================================
      // Tally Voucher Logs
      // ========================================
      let voucherLogsData = [];

      async function loadVoucherLogs() {
        try {
          const typeFilter = document.getElementById("voucherTypeFilter").value;
          const statusFilter = document.getElementById(
            "voucherStatusFilter"
          ).value;
          const fromDate = document.getElementById("voucherFromDate").value;
          const toDate = document.getElementById("voucherToDate").value;
          const searchTerm = document.getElementById("voucherSearch").value;

          const filters = {};
          if (typeFilter) filters.voucherType = typeFilter;
          if (statusFilter) filters.status = statusFilter;
          if (fromDate) filters.fromDate = fromDate;
          if (toDate) filters.toDate = toDate;
          if (searchTerm) filters.search = searchTerm;
          filters.limit = 200;

          const logs = await window.electronAPI.getTallyVoucherLogs(filters);
          voucherLogsData = logs || [];
          renderVoucherLogs();
        } catch (err) {
          console.error("Failed to load voucher logs:", err);
        }
      }

      function renderVoucherLogs() {
        const tbody = document.getElementById("voucherLogsTableBody");
        tbody.innerHTML = "";

        if (voucherLogsData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">ðŸ“„</div><div class="empty-state-text">No voucher logs found</div></td></tr>';
          return;
        }

        voucherLogsData.forEach((log) => {
          const tr = document.createElement("tr");
          const statusClass = log.status === "SUCCESS" ? "success" : "error";
          tr.innerHTML = `
            <td>${log.date}</td>
            <td>${escapeHtml(log.voucher_number)}</td>
            <td>${escapeHtml(log.voucher_type)}</td>
            <td>${escapeHtml(log.party_name || "N/A")}</td>
            <td>â‚¹${parseFloat(log.amount || 0).toLocaleString("en-IN")}</td>
            <td><span class="${statusClass}">${log.status}</span></td>
          `;
          if (log.error_message) {
            tr.style.cursor = "pointer";
            tr.addEventListener("click", () => {
              ModalService.open(
                "Voucher Error",
                `<p><strong>Voucher:</strong> ${escapeHtml(
                  log.voucher_number
                )}</p><p><strong>Error:</strong> ${escapeHtml(
                  log.error_message
                )}</p>`,
                "small",
                null,
                "fa-exclamation-triangle"
              );
            });
          }
          tbody.appendChild(tr);
        });
      }

      document
        .getElementById("voucherTypeFilter")
        .addEventListener("change", loadVoucherLogs);
      document
        .getElementById("voucherStatusFilter")
        .addEventListener("change", loadVoucherLogs);
      document
        .getElementById("voucherFromDate")
        .addEventListener("change", loadVoucherLogs);
      document
        .getElementById("voucherToDate")
        .addEventListener("change", loadVoucherLogs);
      document
        .getElementById("voucherSearch")
        .addEventListener("input", debounce(loadVoucherLogs, 300));
      document
        .getElementById("voucherLogRefreshBtn")
        .addEventListener("click", loadVoucherLogs);

      // ========================================
      // Settings
      // ========================================
      async function loadSettings() {
        try {
          const settings = await window.electronAPI.getAllSettings();

          if (settings.theme) {
            document.getElementById("themeSelect").value = settings.theme;
            setTheme(settings.theme);
          }

          const soundEnabled = settings.soundEnabled !== "false";
          document
            .getElementById("soundToggle")
            .classList.toggle("active", soundEnabled);
          SoundService.setEnabled(soundEnabled);

          if (settings.syncInterval) {
            document.getElementById("syncInterval").value =
              settings.syncInterval;
          }
          if (settings.backgroundSync !== "false") {
            document
              .getElementById("backgroundSyncToggle")
              .classList.add("active");
          }
          // Load API endpoint
          const apiEndpointInput = document.getElementById("apiEndpoint");
          if (settings.apiEndpoint) {
            apiEndpointInput.value = settings.apiEndpoint;
            apiEndpointInput.placeholder = "";
          } else {
            // Should be initialized by main process, but handle gracefully
            apiEndpointInput.value = "";
            apiEndpointInput.placeholder = "Loading...";
          }
          if (settings.apiTimeout) {
            document.getElementById("apiTimeout").value = settings.apiTimeout;
          }
          if (settings.logRetention) {
            document.getElementById("logRetention").value =
              settings.logRetention;
          }
          if (settings.maxLogEntries) {
            document.getElementById("maxLogEntries").value =
              settings.maxLogEntries;
          }
        } catch (err) {
          console.error("Failed to load settings:", err);
        }
      }

      async function saveSettings() {
        try {
          const themeValue = document.getElementById("themeSelect").value;
          await window.electronAPI.setSetting("theme", themeValue);
          if (themeValue !== "auto") {
            setTheme(themeValue);
          }

          await window.electronAPI.setSetting(
            "soundEnabled",
            document
              .getElementById("soundToggle")
              .classList.contains("active")
              .toString()
          );
          await window.electronAPI.setSetting(
            "syncInterval",
            document.getElementById("syncInterval").value
          );
          await window.electronAPI.setSetting(
            "backgroundSync",
            document
              .getElementById("backgroundSyncToggle")
              .classList.contains("active")
              .toString()
          );
          // API endpoint is read-only, managed automatically by the app
          await window.electronAPI.setSetting(
            "apiTimeout",
            document.getElementById("apiTimeout").value
          );
          await window.electronAPI.setSetting(
            "logRetention",
            document.getElementById("logRetention").value
          );
          await window.electronAPI.setSetting(
            "maxLogEntries",
            document.getElementById("maxLogEntries").value
          );

          SoundService.setEnabled(
            document.getElementById("soundToggle").classList.contains("active")
          );
          SoundService.play("success");
        } catch (err) {
          console.error("Failed to save settings:", err);
          SoundService.play("error");
        }
      }

      document.getElementById("themeSelect").addEventListener("change", (e) => {
        const themeValue = e.target.value;
        if (themeValue !== "auto") {
          setTheme(themeValue);
        } else {
          const systemTheme = getSystemTheme();
          setTheme(systemTheme);
        }
        saveSettings();
      });

      document
        .getElementById("soundToggle")
        .addEventListener("click", function () {
          this.classList.toggle("active");
          saveSettings();
        });

      document
        .getElementById("backgroundSyncToggle")
        .addEventListener("click", function () {
          this.classList.toggle("active");
          saveSettings();
        });

      document
        .getElementById("syncInterval")
        .addEventListener("change", saveSettings);
      // API endpoint is read-only, no need for change listener
      document
        .getElementById("apiTimeout")
        .addEventListener("change", saveSettings);
      document
        .getElementById("logRetention")
        .addEventListener("change", saveSettings);
      document
        .getElementById("maxLogEntries")
        .addEventListener("change", saveSettings);

      document
        .getElementById("exportLogsBtn")
        .addEventListener("click", async () => {
          alert("Export functionality coming soon");
        });

      document
        .getElementById("clearAllLogsBtn")
        .addEventListener("click", async () => {
          if (
            confirm(
              "Are you sure you want to clear all logs? This cannot be undone."
            )
          ) {
            try {
              await window.electronAPI.clearLogs("system");
              await window.electronAPI.clearLogs("api");
              await window.electronAPI.clearLogs("voucher");
              SoundService.play("success");
              alert("All logs cleared");
              loadSystemLogs();
              loadApiLogs();
              loadVoucherLogs();
            } catch (err) {
              console.error("Failed to clear logs:", err);
              SoundService.play("error");
            }
          }
        });

      // ========================================
      // Utility Functions
      // ========================================
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function syntaxHighlight(json) {
        if (!json)
          return '<span style="color: var(--text-secondary);">No data</span>';

        try {
          const str =
            typeof json === "string" ? json : JSON.stringify(json, null, 2);
          return escapeHtml(str).replace(
            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            (match) => {
              let cls = "json-number";
              if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                  cls = "json-key";
                } else {
                  cls = "json-string";
                }
              } else if (/true|false/.test(match)) {
                cls = "json-boolean";
              } else if (/null/.test(match)) {
                cls = "json-boolean";
              }
              return `<span class="${cls}">${match}</span>`;
            }
          );
        } catch (e) {
          return '<span style="color: var(--text-secondary);">Invalid JSON</span>';
        }
      }

      window.copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          SoundService.play("success");
        } catch (err) {
          console.error("Failed to copy:", err);
          SoundService.play("error");
        }
      };
    </script>
  </body>
</html>
